<template>
  <div class="search-page">
    <div class="page-header">
      <div class="header-left">
        <h1>üìä Êï∞ÊçÆÊü•ËØ¢</h1>
        <p class="subtitle">Âº∫Â§ßÁöÑElasticsearchÊï∞ÊçÆÊü•ËØ¢Â∑•ÂÖ∑</p>
      </div>
      <div class="header-right">
        <a-space>
          <a-segmented 
            v-model="queryMode" 
            :options="queryModeOptions"
            size="large"
            @change="onQueryModeChange"
          />
          <a-button @click="executeSearch" :loading="searchStore.loading" type="primary" size="large">
            <template #icon>
              <icon-search />
            </template>
            ÊâßË°åÊü•ËØ¢
          </a-button>
          <a-button @click="clearResults" size="large">
            <template #icon>
              <icon-delete />
            </template>
            Ê∏ÖÁ©∫ÁªìÊûú
          </a-button>
        </a-space>
      </div>
    </div>

    <div v-if="!connectionStore.currentConnection" class="no-connection">
      <a-empty description="ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËøûÊé•" />
    </div>

    <div v-else class="search-content">
      <!-- ‰∏äÂçäÈÉ®ÂàÜÔºöÊü•ËØ¢ÈÖçÁΩÆÂíåÊü•ËØ¢Êù°‰ª∂ -->
      <div class="query-row">
        <a-row :gutter="24">
          <!-- Êü•ËØ¢ÈÖçÁΩÆÂå∫Âüü -->
          <a-col :span="12">
            <a-card class="config-card">
              <template #title>
                <div class="card-title">
                  <icon-filter />
                  <span>Êü•ËØ¢ÈÖçÁΩÆ</span>
                </div>
              </template>
              
              <a-form :model="queryForm" layout="vertical">
                <a-form-item label="Á¥¢ÂºïÂêçÁß∞" required>
                  <a-select 
                    v-model="queryForm.index" 
                    placeholder="ÈÄâÊã©Á¥¢Âºï"
                    allow-search
                    size="large"
                    @focus="loadIndices"
                    @change="onIndexChange"
                  >
                    <a-option 
                      v-for="index in indexStore.indices" 
                      :key="index.name" 
                      :value="index.name"
                    >
                      <div class="index-option">
                        <div class="index-name">{{ index.name }}</div>
                        <div class="index-info">
                          ÊñáÊ°£: {{ formatNumber(index.docs_count || 0) }} | 
                          Â§ßÂ∞è: {{ index.store_size || 'N/A' }}
                        </div>
                      </div>
                    </a-option>
                  </a-select>
                </a-form-item>

                <a-row :gutter="12">
                  <a-col :span="12">
                    <a-form-item label="Ëµ∑Âßã‰ΩçÁΩÆ">
                      <a-input-number 
                        v-model="queryForm.from" 
                        :min="0" 
                        placeholder="0"
                        style="width: 100%"
                      />
                    </a-form-item>
                  </a-col>
                  <a-col :span="12">
                    <a-form-item label="ËøîÂõûÊï∞Èáè">
                      <a-input-number 
                        v-model="queryForm.size" 
                        :min="1" 
                        :max="10000"
                        placeholder="10"
                        style="width: 100%"
                      />
                    </a-form-item>
                  </a-col>
                </a-row>
              </a-form>
            </a-card>
          </a-col>

          <!-- ÁÆÄÂçïÊü•ËØ¢ÊàñÈ´òÁ∫ßÊü•ËØ¢Âå∫Âüü -->
          <a-col :span="12">
            <!-- ÁÆÄÂçïÊü•ËØ¢Ê®°Âºè -->
            <a-card v-if="queryMode === 'simple'" class="simple-query-card">
              <template #title>
                <div class="card-title">
                  <icon-search />
                  <span>ÁÆÄÂçïÊü•ËØ¢</span>
                </div>
              </template>
              
              <!-- Âø´ÈÄüÊêúÁ¥¢ -->
              <div class="quick-search">
                <a-input
                  v-model="simpleQuery.quickSearch"
                  placeholder="üîç ÊêúÁ¥¢ÊâÄÊúâÂ≠óÊÆµ..."
                  size="large"
                  @press-enter="addQuickFilter"
                >
                  <template #suffix>
                    <a-button 
                      type="text" 
                      @click="addQuickFilter"
                      :disabled="!simpleQuery.quickSearch"
                    >
                      <icon-plus />
                    </a-button>
                  </template>
                </a-input>
              </div>

              <!-- Êù°‰ª∂ÂàóË°® -->
              <div class="conditions-list" style="margin-top: 1rem;">
                <div class="section-header">
                  <h4>Êü•ËØ¢Êù°‰ª∂</h4>
                  <a-button size="small" @click="showAddConditionModal" type="dashed">
                    <template #icon>
                      <icon-plus />
                    </template>
                    Ê∑ªÂä†Êù°‰ª∂
                  </a-button>
                </div>
                
                <div class="conditions">
                  <div 
                    v-for="(condition, index) in simpleQuery.conditions" 
                    :key="condition.id"
                    class="condition-item"
                  >
                    <div class="condition-content">
                      <a-tag :color="getConditionTypeColor(condition.type)">
                        {{ getConditionTypeLabel(condition.type) }}
                      </a-tag>
                      <span class="field-name">{{ condition.field }}</span>
                      <span class="operator">{{ getOperatorLabel(condition.operator) }}</span>
                      <span class="condition-value">{{ condition.value }}</span>
                    </div>
                    <a-button 
                      type="text" 
                      status="danger" 
                      @click="removeCondition(index)"
                      size="small"
                    >
                      <template #icon>
                        <icon-close />
                      </template>
                    </a-button>
                  </div>
                  
                  <div v-if="simpleQuery.conditions.length === 0" class="empty-conditions">
                    <a-empty description="ÊöÇÊó†Êü•ËØ¢Êù°‰ª∂" :image-style="{height: '60px'}">
                      <template #image>
                        <icon-filter :size="60" />
                      </template>
                    </a-empty>
                  </div>
                </div>
              </div>

              <!-- ÊéíÂ∫èËÆæÁΩÆ -->
              <div class="sort-section" style="margin-top: 1rem;">
                <div class="section-header">
                  <h4>ÊéíÂ∫èËÆæÁΩÆ</h4>
                  <a-button size="small" @click="addSort" type="dashed">
                    <template #icon>
                      <icon-plus />
                    </template>
                    Ê∑ªÂä†ÊéíÂ∫è
                  </a-button>
                </div>
                
                <div class="sort-list">
                  <div 
                    v-for="(sort, index) in simpleQuery.sort" 
                    :key="index"
                    class="sort-item"
                  >
                    <a-select v-model="sort.field" placeholder="ÈÄâÊã©Â≠óÊÆµ" style="flex: 1;">
                      <a-option v-for="field in availableFields" :key="field" :value="field">
                        {{ field }}
                      </a-option>
                    </a-select>
                    <a-select v-model="sort.order" style="width: 100px;">
                      <a-option value="asc">ÂçáÂ∫è</a-option>
                      <a-option value="desc">ÈôçÂ∫è</a-option>
                    </a-select>
                    <a-button type="text" status="danger" @click="removeSort(index)">
                      <template #icon>
                        <icon-close />
                      </template>
                    </a-button>
                  </div>
                </div>
              </div>
            </a-card>

            <!-- È´òÁ∫ßÊü•ËØ¢Ê®°Âºè -->
            <a-card v-else class="advanced-query-card">
              <template #title>
                <div class="card-title">
                  <icon-code />
                  <span>È´òÁ∫ßÊü•ËØ¢</span>
                </div>
              </template>
              
              <a-form-item label="Êü•ËØ¢Êù°‰ª∂ÔºàJSONÔºâ">
                <QueryEditor
                  v-model="queryText"
                  placeholder="ËØ∑ËæìÂÖ•Êü•ËØ¢JSON..."
                  height="200px"
                  :connection-id="connectionStore.currentConnection?.id"
                  :selected-index="queryForm.index"
                  :show-validation="true"
                  :format-on-blur="true"
                  :enable-autocomplete="true"
                  @validation-change="onQueryValidationChange"
                />
                <div class="autocomplete-hint">
                  <div class="hint-icon">üí°</div>
                  <div class="hint-text">
                    ÊîØÊåÅÂ≠óÊÆµÂêçÂíåÊü•ËØ¢ËØ≠Ê≥ïËá™Âä®Ë°•ÂÖ®ÔºåÊåâ <kbd>Ctrl+Space</kbd> Ëß¶ÂèëË°•ÂÖ®ËèúÂçï
                  </div>
                </div>
              </a-form-item>

              <a-form-item label="ÊéíÂ∫èÊù°‰ª∂ÔºàJSONÔºåÂèØÈÄâÔºâ">
                <JsonEditor
                  v-model="sortText"
                  placeholder="ËØ∑ËæìÂÖ•ÊéíÂ∫èJSONÔºàÂèØÈÄâÔºâ..."
                  height="80px"
                  :show-validation="true"
                  :format-on-blur="true"
                  @validation-change="onSortValidationChange"
                />
              </a-form-item>

              <!-- Âø´ÈÄüÊü•ËØ¢Ê®°Êùø -->
              <a-form-item label="Âø´ÈÄüÊ®°Êùø">
                <a-space size="small" wrap>
                  <a-button size="small" @click="setTemplate('match_all')">
                    Êü•ËØ¢ÊâÄÊúâ
                  </a-button>
                  <a-button size="small" @click="setTemplate('match')">
                    ÂåπÈÖçÊü•ËØ¢
                  </a-button>
                  <a-button size="small" @click="setTemplate('range')">
                    ËåÉÂõ¥Êü•ËØ¢
                  </a-button>
                  <a-button size="small" @click="setTemplate('bool')">
                    Â∏ÉÂ∞îÊü•ËØ¢
                  </a-button>
                  <a-button size="small" @click="setTemplate('terms_agg')" type="outline">
                    ÂàÜÁªÑËÅöÂêà
                  </a-button>
                  <a-button size="small" @click="setTemplate('date_histogram')" type="outline">
                    Êó∂Èó¥ËÅöÂêà
                  </a-button>
                  <a-button size="small" @click="setTemplate('stats_agg')" type="outline">
                    ÁªüËÆ°ËÅöÂêà
                  </a-button>
                </a-space>
              </a-form-item>
            </a-card>
          </a-col>
        </a-row>
      </div>

      <!-- ‰∏ãÂçäÈÉ®ÂàÜÔºöÊü•ËØ¢ÁªìÊûú -->
      <div class="results-row">
        <a-card class="results-card">
            <template #title>
              <div class="result-title">
                Êü•ËØ¢ÁªìÊûú
                <span v-if="searchResult" class="result-stats">
                  ÔºàÂÖ± {{ searchResult.total }} Êù°ÔºåËÄóÊó∂ {{ searchResult.took }}msÔºâ
                </span>
              </div>
            </template>

            <div v-if="!searchResult" class="no-result">
              <a-empty description="ÊöÇÊó†Êü•ËØ¢ÁªìÊûú" />
            </div>

            <div v-else>
              <a-tabs default-active-key="table" :lazy-load="true">
                <!-- Ë°®Ê†ºËßÜÂõæ -->
                <a-tab-pane key="table" title="Ë°®Ê†ºËßÜÂõæ">
                  <div class="table-controls">
                    <a-space>
                      <span>ÊòæÁ§∫Ê®°ÂºèÔºö</span>
                      <a-radio-group v-model="viewMode" size="small">
                        <a-radio value="virtual">ËôöÊãüÊªöÂä®</a-radio>
                        <a-radio value="pagination">ÂàÜÈ°µÊ®°Âºè</a-radio>
                      </a-radio-group>
                      <a-divider type="vertical" />
                      <span>ÊòæÁ§∫Â≠óÊÆµÔºö</span>
                      <a-select
                        v-model="selectedFields"
                        multiple
                        :max-tag-count="3"
                        placeholder="ÈÄâÊã©Ë¶ÅÊòæÁ§∫ÁöÑÂ≠óÊÆµ"
                        style="min-width: 200px"
                        allow-clear
                      >
                        <a-option 
                          v-for="field in extractFieldsFromResults(searchResult.hits)" 
                          :key="field" 
                          :value="field"
                        >
                          {{ field }}
                        </a-option>
                      </a-select>
                      <a-button size="small" @click="selectAllFields" type="outline">
                        ÂÖ®ÈÄâ
                      </a-button>
                      <a-button size="small" @click="clearFieldSelection" type="outline">
                        Ê∏ÖÁ©∫
                      </a-button>
                      <span v-if="searchResult" class="data-info">
                        ÂΩìÂâçÊòæÁ§∫ {{ searchResult.hits.length }} Êù°ÔºåÂÖ± {{ searchResult.total }} Êù°ËÆ∞ÂΩï
                      </span>
                    </a-space>
                  </div>

                  <!-- ËôöÊãüÊªöÂä®Ë°®Ê†º -->
                  <VirtualTable
                    v-if="viewMode === 'virtual'"
                    :data="searchResult.hits"
                    :columns="tableColumns"
                    :container-height="500"
                    :item-height="60"
                    :loading="searchStore.loadingMore"
                    :has-more="hasMoreData"
                    @load-more="loadMoreData"
                    @row-click="onRowClick"
                  >
                    <template #_index="{ record }">
                      <span class="metadata-value">{{ record._index }}</span>
                    </template>
                    <template #_type="{ record }">
                      <span class="metadata-value">{{ record._type || '-' }}</span>
                    </template>
                    <template #_id="{ record }">
                      <span class="doc-id">{{ record._id }}</span>
                    </template>
                    <template #_score="{ record }">
                      <span class="score-badge">{{ record._score?.toFixed(3) || 'N/A' }}</span>
                    </template>
                    <!-- Âä®ÊÄÅÂ≠óÊÆµÊèíÊßΩ -->
                    <template v-for="field in (selectedFields.length > 0 ? selectedFields.filter(f => searchResult?.hits && extractFieldsFromResults(searchResult.hits).includes(f)) : (searchResult?.hits ? extractFieldsFromResults(searchResult.hits).slice(0, 10) : []))" :key="`_source.${field}`" #[`_source.${field}`]="{ record }">
                      <div class="field-cell">
                        <span class="field-value" :title="formatFieldValue(getFieldValue(record._source, field))">
                          {{ formatFieldValue(getFieldValue(record._source, field)) }}
                        </span>
                      </div>
                    </template>
                  </VirtualTable>

                  <!-- ‰º†ÁªüÂàÜÈ°µË°®Ê†º -->
                  <a-table 
                    v-else
                    :data="searchResult.hits"
                    :pagination="false"
                    :scroll="{ x: '100%', y: '400px' }"
                    size="small"
                  >
                    <template #columns>
                      <a-table-column title="Á¥¢Âºï" data-index="_index" :width="120">
                        <template #cell="{ record }">
                          <span class="metadata-value">{{ record._index }}</span>
                        </template>
                      </a-table-column>
                      <a-table-column title="Á±ªÂûã" data-index="_type" :width="100">
                        <template #cell="{ record }">
                          <span class="metadata-value">{{ record._type || '-' }}</span>
                        </template>
                      </a-table-column>
                      <a-table-column title="ID" data-index="_id" :width="180">
                        <template #cell="{ record }">
                          <span class="doc-id">{{ record._id }}</span>
                        </template>
                      </a-table-column>
                      <a-table-column title="ËØÑÂàÜ" data-index="_score" :width="80">
                        <template #cell="{ record }">
                          <span class="score-badge">{{ record._score?.toFixed(3) || 'N/A' }}</span>
                        </template>
                      </a-table-column>
                      <!-- Âä®ÊÄÅÂ≠óÊÆµÂàó -->
                      <a-table-column 
                        v-for="field in (selectedFields.length > 0 ? selectedFields.filter(f => searchResult?.hits && extractFieldsFromResults(searchResult.hits).includes(f)) : (searchResult?.hits ? extractFieldsFromResults(searchResult.hits).slice(0, 10) : []))" 
                        :key="field"
                        :title="field"
                        :width="parseInt(getOptimalColumnWidth(field, searchResult?.hits || []))"
                      >
                        <template #cell="{ record }">
                          <div class="field-cell">
                            <span 
                              class="field-value" 
                              :title="formatFieldValue(getFieldValue(record._source, field))"
                            >
                              {{ formatFieldValue(getFieldValue(record._source, field)) }}
                            </span>
                          </div>
                        </template>
                      </a-table-column>
                    </template>
                  </a-table>
                </a-tab-pane>

                <!-- ÂèØËßÜÂåñËßÜÂõæ -->
                <a-tab-pane key="visualization" title="ÂèØËßÜÂåñ" v-if="hasAggregations">
                  <VisualizationPanel 
                    :search-result="searchResult"
                    :key="visualizationKey"
                  />
                </a-tab-pane>

                <!-- JSONËßÜÂõæ -->
                <a-tab-pane key="json" title="JSONËßÜÂõæ">
                  <pre class="json-result">{{ JSON.stringify(searchResult, null, 2) }}</pre>
                </a-tab-pane>
              </a-tabs>

              <!-- ÂàÜÈ°µ -->
              <div class="pagination-wrapper" v-if="viewMode === 'pagination'">
                <a-pagination 
                  :current="currentPage"
                  :page-size="queryForm.size || 10"
                  :total="searchResult.total"
                  @change="onPageChange"
                  @page-size-change="onPageSizeChange"
                  show-total
                  show-jumper
                  show-page-size
                  :page-size-options="['10', '20', '50', '100', '200']"
                />
              </div>
            </div>
        </a-card>
      </div>
    </div>

    <!-- Ê∑ªÂä†Êù°‰ª∂ÂºπÁ™ó -->
    <a-modal
      v-model:visible="addConditionModalVisible"
      title="Ê∑ªÂä†Êü•ËØ¢Êù°‰ª∂"
      @ok="handleAddCondition"
      @cancel="resetConditionForm"
      :ok-button-props="{ disabled: !isConditionFormValid }"
      width="600px"
    >
        <a-form :model="conditionForm" layout="vertical">
          <a-row :gutter="16">
            <a-col :span="12">
              <a-form-item label="Â≠óÊÆµÂêçÁß∞" required>
                <a-select 
                  v-model="conditionForm.field" 
                  placeholder="ÈÄâÊã©Â≠óÊÆµ"
                  allow-search
                  @change="onFieldChange"
                >
                  <a-option v-for="field in availableFields" :key="field" :value="field">
                    {{ field }}
                  </a-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="12">
              <a-form-item label="Êù°‰ª∂Á±ªÂûã" required>
                <a-select v-model="conditionForm.type" @change="onConditionTypeChange">
                  <a-option value="match">ÂåπÈÖçÊü•ËØ¢</a-option>
                  <a-option value="term">Á≤æÁ°ÆÂåπÈÖç</a-option>
                  <a-option value="range">ËåÉÂõ¥Êü•ËØ¢</a-option>
                  <a-option value="wildcard">ÈÄöÈÖçÁ¨¶Êü•ËØ¢</a-option>
                  <a-option value="exists">Â≠óÊÆµÂ≠òÂú®</a-option>
                </a-select>
              </a-form-item>
            </a-col>
          </a-row>
          
          <a-row :gutter="16" v-if="conditionForm.type !== 'exists'">
            <a-col :span="12">
              <a-form-item label="Êìç‰ΩúÁ¨¶" required>
                <a-select v-model="conditionForm.operator">
                  <a-option v-for="op in availableOperators" :key="op.value" :value="op.value">
                    {{ op.label }}
                  </a-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="12">
              <a-form-item label="ÂÄº" required>
                <a-input 
                  v-if="conditionForm.type !== 'range'"
                  v-model="conditionForm.value" 
                  placeholder="ËæìÂÖ•ÂÄº"
                />
                <div v-else class="range-inputs">
                  <a-input 
                    v-model="conditionForm.rangeFrom" 
                    placeholder="ÊúÄÂ∞èÂÄº"
                    style="width: 45%"
                  />
                  <span style="width: 10%; text-align: center;">-</span>
                  <a-input 
                    v-model="conditionForm.rangeTo" 
                    placeholder="ÊúÄÂ§ßÂÄº"
                    style="width: 45%"
                  />
                </div>
              </a-form-item>
            </a-col>
          </a-row>
        </a-form>
      </a-modal>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, watch, nextTick } from 'vue'
import { useConnectionStore } from '../stores/connection'
import { useIndexStore } from '../stores/index'
import { useSearchStore } from '../stores/search'
import { 
  IconSearch, 
  IconDelete, 
  IconFilter, 
  IconCode, 
  IconPlus, 
  IconClose 
} from '@arco-design/web-vue/es/icon'
import { Message } from '@arco-design/web-vue'
import VisualizationPanel from '../components/VisualizationPanel.vue'
import JsonEditor from '../components/JsonEditor.vue'
import QueryEditor from '../components/QueryEditor.vue'
import VirtualTable from '../components/VirtualTable.vue'
import { Api } from '../api'

const connectionStore = useConnectionStore()
const indexStore = useIndexStore()
const searchStore = useSearchStore()

// Êü•ËØ¢Ê®°Âºè
const queryMode = ref('simple')
const queryModeOptions = [
  { label: 'üéØ ÁÆÄÂçïÊü•ËØ¢', value: 'simple' },
  { label: '‚ö° È´òÁ∫ßÊü•ËØ¢', value: 'advanced' }
]

const queryForm = ref({
  index: '',
  from: 0,
  size: 10
})

// È´òÁ∫ßÊü•ËØ¢Áõ∏ÂÖ≥
const queryText = ref('{\n  "match_all": {}\n}')
const sortText = ref('')
const queryValid = ref(true)
const sortValid = ref(true)
const queryValidationError = ref('')
const sortValidationError = ref('')

// ÁÆÄÂçïÊü•ËØ¢Áõ∏ÂÖ≥
const simpleQuery = ref({
  quickSearch: '',
  conditions: [] as any[],
  sort: [] as any[]
})

// Ê∑ªÂä†Êù°‰ª∂ÂºπÁ™ó
const addConditionModalVisible = ref(false)
const conditionForm = ref({
  field: '',
  type: 'match',
  operator: 'eq',
  value: '',
  rangeFrom: '',
  rangeTo: ''
})

// ÂèØÁî®Â≠óÊÆµ
const availableFields = ref<string[]>([])

// ÊêúÁ¥¢ÁªìÊûú
const searchResult = computed(() => searchStore.searchResult)
const viewMode = ref('pagination')

// Â≠óÊÆµÈÄâÊã©
const selectedFields = ref<string[]>([])

// ËôöÊãüÊªöÂä®ÁöÑÊï∞ÊçÆÁÆ°ÁêÜ
const allData = ref<any[]>([])
const isLoadingMore = ref(false)

// Âä®ÊÄÅË°®Ê†ºÂàóÂÆö‰πâ
const tableColumns = computed(() => {
  if (!searchResult.value || !searchResult.value.hits || searchResult.value.hits.length === 0) {
    return [
      { key: '_index', title: 'Á¥¢Âºï', width: '120px' },
      { key: '_type', title: 'Á±ªÂûã', width: '100px' },
      { key: '_id', title: 'ID', width: '150px' },
      { key: '_score', title: 'ËØÑÂàÜ', width: '80px' }
    ]
  }

  // ‰ªéÊêúÁ¥¢ÁªìÊûú‰∏≠ÊèêÂèñÊâÄÊúâÂ≠óÊÆµ
  const allSourceFields = extractFieldsFromResults(searchResult.value.hits)
  
  // Ê†πÊçÆÁî®Êà∑ÈÄâÊã©ÂÜ≥ÂÆöÊòæÁ§∫Âì™‰∫õÂ≠óÊÆµ
  const fieldsToShow = selectedFields.value.length > 0 
    ? selectedFields.value.filter(field => allSourceFields.includes(field))
    : allSourceFields.slice(0, 10) // ÈªòËÆ§ÊòæÁ§∫Ââç10‰∏™Â≠óÊÆµ
  
  // Âü∫Á°ÄÂÖÉÊï∞ÊçÆÂàó
  const baseColumns = [
    { key: '_index', title: 'Á¥¢Âºï', width: '120px' },
    { key: '_type', title: 'Á±ªÂûã', width: '100px' },
    { key: '_id', title: 'ID', width: '180px' },
    { key: '_score', title: 'ËØÑÂàÜ', width: '80px' }
  ]
  
  // Âä®ÊÄÅÂ≠óÊÆµÂàó
  const fieldColumns = fieldsToShow.map(field => ({
    key: `_source.${field}`,
    title: field,
    width: getOptimalColumnWidth(field, searchResult.value!.hits)
  }))
  
  return [...baseColumns, ...fieldColumns]
})

// ÊòØÂê¶ÊúâÊõ¥Â§öÊï∞ÊçÆ
const hasMoreData = computed(() => {
  if (!searchResult.value) return false
  return allData.value.length < (searchResult.value.total || 0)
})

// Ê£ÄÊü•ÊêúÁ¥¢ÁªìÊûúÊòØÂê¶ÂåÖÂê´ËÅöÂêàÊï∞ÊçÆ
const hasAggregations = computed(() => {
  return searchResult.value?.aggregations && 
         Object.keys(searchResult.value.aggregations).length > 0
})

// ÂèØËßÜÂåñÁªÑ‰ª∂ÁöÑkey
const visualizationKey = ref(0)

// ËÆ°ÁÆóÂΩìÂâçÈ°µÊï∞
const currentPage = computed(() => {
  const from = queryForm.value.from || 0
  const size = queryForm.value.size || 10
  return Math.floor(from / size) + 1
})

// Êù°‰ª∂Ë°®ÂçïÈ™åËØÅ
const isConditionFormValid = computed(() => {
  if (!conditionForm.value.field || !conditionForm.value.type) return false
  if (conditionForm.value.type === 'exists') return true
  if (conditionForm.value.type === 'range') {
    return conditionForm.value.rangeFrom && conditionForm.value.rangeTo
  }
  return conditionForm.value.value
})

// ÂèØÁî®Êìç‰ΩúÁ¨¶
const availableOperators = computed(() => {
  const type = conditionForm.value.type
  switch (type) {
    case 'match':
    case 'wildcard':
      return [
        { label: 'ÂåÖÂê´', value: 'contains' },
        { label: '‰∏çÂåÖÂê´', value: 'not_contains' }
      ]
    case 'term':
      return [
        { label: 'Á≠â‰∫é', value: 'eq' },
        { label: '‰∏çÁ≠â‰∫é', value: 'neq' }
      ]
    case 'range':
      return [
        { label: 'ËåÉÂõ¥', value: 'range' }
      ]
    default:
      return [{ label: 'Á≠â‰∫é', value: 'eq' }]
  }
})

// Êï∞Â≠óÊ†ºÂºèÂåñ
const formatNumber = (num: number) => {
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K'
  return num?.toString() || '0'
}

// Êü•ËØ¢Ê®°Êùø
const templates = {
  match_all: '{\n  "match_all": {}\n}',
  match: '{\n  "match": {\n    "field_name": "search_value"\n  }\n}',
  range: '{\n  "range": {\n    "field_name": {\n      "gte": 10,\n      "lte": 20\n    }\n  }\n}',
  bool: '{\n  "bool": {\n    "must": [\n      { "match": { "field1": "value1" } }\n    ],\n    "filter": [\n      { "term": { "field2": "value2" } }\n    ]\n  }\n}',
  terms_agg: '{\n  "match_all": {},\n  "aggs": {\n    "field_terms": {\n      "terms": {\n        "field": "field_name.keyword",\n        "size": 10\n      }\n    }\n  }\n}',
  date_histogram: '{\n  "match_all": {},\n  "aggs": {\n    "date_trend": {\n      "date_histogram": {\n        "field": "@timestamp",\n        "calendar_interval": "day"\n      }\n    }\n  }\n}',
  stats_agg: '{\n  "match_all": {},\n  "aggs": {\n    "field_stats": {\n      "stats": {\n        "field": "numeric_field"\n      }\n    }\n  }\n}'
}

onMounted(() => {
  if (connectionStore.currentConnection) {
    loadIndices()
  }
  
  // ‰ªéstore‰∏≠ÊÅ¢Â§çÊü•ËØ¢Êù°‰ª∂
  if (searchStore.query.index) {
    queryForm.value.index = searchStore.query.index
    queryForm.value.from = searchStore.query.from || 0
    queryForm.value.size = searchStore.query.size || 10
    if (queryMode.value === 'advanced') {
      queryText.value = JSON.stringify(searchStore.query.query, null, 2)
    }
  }
})

watch(
  () => connectionStore.currentConnection,
  (newConnection) => {
    if (newConnection) {
      loadIndices()
    }
  }
)

// Êñ∞Â¢ûÊñπÊ≥ï

// Êü•ËØ¢Ê®°ÂºèÂàáÊç¢
const onQueryModeChange = (mode: string) => {
  queryMode.value = mode
  if (mode === 'simple') {
    // ÂàáÊç¢Âà∞ÁÆÄÂçïÊ®°ÂºèÊó∂ÔºåÂ∞ùËØïËß£ÊûêÂΩìÂâçÁöÑJSONÊü•ËØ¢
    try {
      const query = JSON.parse(queryText.value)
      // ÁÆÄÂçïÁöÑËΩ¨Êç¢ÈÄªËæë
      if (query.match_all) {
        simpleQuery.value.conditions = []
      }
    } catch (e) {
      // Ëß£ÊûêÂ§±Ë¥•Êó∂ÈáçÁΩÆÁÆÄÂçïÊü•ËØ¢
      simpleQuery.value = {
        quickSearch: '',
        conditions: [],
        sort: []
      }
    }
  } else {
    // ÂàáÊç¢Âà∞È´òÁ∫ßÊ®°ÂºèÊó∂ÔºåÂ∞ÜÁÆÄÂçïÊü•ËØ¢ËΩ¨Êç¢‰∏∫JSON
    if (simpleQuery.value.conditions.length > 0) {
      const query = buildQueryFromConditions()
      queryText.value = JSON.stringify(query, null, 2)
    }
  }
}

// Á¥¢ÂºïÂèòÂåñÊó∂Âä†ËΩΩÂ≠óÊÆµÊò†Â∞Ñ
const onIndexChange = async (indexName: string) => {
  if (!connectionStore.currentConnection || !indexName) return
  
  try {
    const mapping = await Api.getIndexMapping(connectionStore.currentConnection.id, indexName)
    // Ëß£ÊûêÂ≠óÊÆµÊò†Â∞Ñ
    availableFields.value = extractFieldsFromMapping(mapping)
  } catch (error) {
    console.error('Failed to load field mapping:', error)
    availableFields.value = []
  }
}

// ‰ªéÊò†Â∞Ñ‰∏≠ÊèêÂèñÂ≠óÊÆµ
const extractFieldsFromMapping = (mapping: any): string[] => {
  const fields: string[] = []
  
  const traverse = (obj: any, prefix = '') => {
    for (const key in obj) {
      if (key === 'properties') {
        traverse(obj[key], prefix)
      } else if (typeof obj[key] === 'object' && obj[key].type) {
        const fieldName = prefix ? `${prefix}.${key}` : key
        fields.push(fieldName)
        if (obj[key].properties) {
          traverse(obj[key].properties, fieldName)
        }
      }
    }
  }
  
  if (mapping && typeof mapping === 'object') {
    Object.keys(mapping).forEach(indexName => {
      if (mapping[indexName] && mapping[indexName].mappings) {
        traverse(mapping[indexName].mappings)
      }
    })
  }
  
  return [...new Set(fields)].sort()
}

// ‰ªéÊêúÁ¥¢ÁªìÊûú‰∏≠ÊèêÂèñÊâÄÊúâÂ≠óÊÆµ
const extractFieldsFromResults = (hits: any[]): string[] => {
  const fieldSet = new Set<string>()
  
  const traverseObject = (obj: any, prefix = '') => {
    if (!obj || typeof obj !== 'object') return
    
    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        const fieldPath = prefix ? `${prefix}.${key}` : key
        const value = obj[key]
        
        if (value !== null && value !== undefined) {
          if (Array.isArray(value)) {
            fieldSet.add(fieldPath)
            // Â¶ÇÊûúÊï∞ÁªÑ‰∏≠ÊúâÂØπË±°ÔºåÈÄíÂΩíÂ§ÑÁêÜ
            if (value.length > 0 && typeof value[0] === 'object') {
              traverseObject(value[0], fieldPath)
            }
          } else if (typeof value === 'object') {
            // ÂØπ‰∫éÂµåÂ•óÂØπË±°ÔºåÊó¢Ê∑ªÂä†Áà∂Â≠óÊÆµ‰πüÈÄíÂΩíÂ§ÑÁêÜÂ≠êÂ≠óÊÆµ
            fieldSet.add(fieldPath)
            traverseObject(value, fieldPath)
          } else {
            fieldSet.add(fieldPath)
          }
        }
      }
    }
  }
  
  // ÂàÜÊûêÂâç20Êù°ËÆ∞ÂΩï‰ª•Ëé∑ÂèñÂ≠óÊÆµÁªìÊûÑ
  const sampleSize = Math.min(hits.length, 20)
  for (let i = 0; i < sampleSize; i++) {
    if (hits[i]._source) {
      traverseObject(hits[i]._source)
    }
  }
  
  return Array.from(fieldSet).sort()
}

// ËÆ°ÁÆóÊúÄ‰Ω≥ÂàóÂÆΩ
const getOptimalColumnWidth = (fieldName: string, hits: any[]): string => {
  // Âü∫‰∫éÂ≠óÊÆµÂêçÁß∞ÈïøÂ∫¶ÁöÑÂü∫Á°ÄÂÆΩÂ∫¶
  const fieldNameLength = fieldName.length
  let baseWidth = Math.max(80, fieldNameLength * 8 + 40)
  
  // ÂàÜÊûêÂ≠óÊÆµÂÄºÁöÑÈïøÂ∫¶ÔºàÊ†∑Êú¨Ââç10Êù°ËÆ∞ÂΩïÔºâ
  const sampleSize = Math.min(hits.length, 10)
  let maxValueLength = 0
  
  for (let i = 0; i < sampleSize; i++) {
    const value = getFieldValue(hits[i]._source, fieldName)
    if (value !== null && value !== undefined) {
      const stringValue = formatFieldValue(value)
      maxValueLength = Math.max(maxValueLength, stringValue.length)
    }
  }
  
  // Ê†πÊçÆÂÄºÁöÑÈïøÂ∫¶Ë∞ÉÊï¥ÂÆΩÂ∫¶
  const contentWidth = Math.max(baseWidth, maxValueLength * 8 + 40)
  
  // ËÆæÁΩÆÊúÄÂ∞èÂíåÊúÄÂ§ßÂÆΩÂ∫¶ÈôêÂà∂
  const finalWidth = Math.max(80, Math.min(300, contentWidth))
  
  return `${finalWidth}px`
}

// Ëé∑ÂèñÂµåÂ•óÂ≠óÊÆµÁöÑÂÄº
const getFieldValue = (obj: any, fieldPath: string): any => {
  if (!obj || !fieldPath) return null
  
  const keys = fieldPath.split('.')
  let current = obj
  
  for (const key of keys) {
    if (current && typeof current === 'object' && key in current) {
      current = current[key]
    } else {
      return null
    }
  }
  
  return current
}

// Ê†ºÂºèÂåñÂ≠óÊÆµÂÄºÁî®‰∫éÊòæÁ§∫
const formatFieldValue = (value: any): string => {
  if (value === null || value === undefined) {
    return ''
  }
  
  if (Array.isArray(value)) {
    if (value.length === 0) return '[]'
    if (value.length === 1) return formatFieldValue(value[0])
    return `[${value.length} items]`
  }
  
  if (typeof value === 'object') {
    return JSON.stringify(value, null, 0)
  }
  
  if (typeof value === 'string' && value.length > 100) {
    return value.substring(0, 97) + '...'
  }
  
  return String(value)
}

// Âø´ÈÄüÊêúÁ¥¢
const addQuickFilter = () => {
  if (!simpleQuery.value.quickSearch.trim()) return
  
  const condition = {
    id: Date.now().toString(),
    field: '_all',
    type: 'match',
    operator: 'contains',
    value: simpleQuery.value.quickSearch.trim()
  }
  
  simpleQuery.value.conditions.push(condition)
  simpleQuery.value.quickSearch = ''
}

// ÊòæÁ§∫Ê∑ªÂä†Êù°‰ª∂ÂºπÁ™ó
const showAddConditionModal = () => {
  resetConditionForm()
  addConditionModalVisible.value = true
}

// ÈáçÁΩÆÊù°‰ª∂Ë°®Âçï
const resetConditionForm = () => {
  conditionForm.value = {
    field: '',
    type: 'match',
    operator: 'eq',
    value: '',
    rangeFrom: '',
    rangeTo: ''
  }
}

// Â§ÑÁêÜÊ∑ªÂä†Êù°‰ª∂
const handleAddCondition = () => {
  if (!isConditionFormValid.value) return
  
  const condition = {
    id: Date.now().toString(),
    field: conditionForm.value.field,
    type: conditionForm.value.type,
    operator: conditionForm.value.operator,
    value: conditionForm.value.type === 'range' 
      ? `${conditionForm.value.rangeFrom} - ${conditionForm.value.rangeTo}`
      : conditionForm.value.value
  }
  
  simpleQuery.value.conditions.push(condition)
  addConditionModalVisible.value = false
  resetConditionForm()
}

// ÁßªÈô§Êù°‰ª∂
const removeCondition = (index: number) => {
  simpleQuery.value.conditions.splice(index, 1)
}

// Ê∑ªÂä†ÊéíÂ∫è
const addSort = () => {
  simpleQuery.value.sort.push({
    field: '',
    order: 'desc'
  })
}

// ÁßªÈô§ÊéíÂ∫è
const removeSort = (index: number) => {
  simpleQuery.value.sort.splice(index, 1)
}

// Â≠óÊÆµÂèòÂåñ
const onFieldChange = () => {
  conditionForm.value.operator = availableOperators.value[0]?.value || 'eq'
}

// Êù°‰ª∂Á±ªÂûãÂèòÂåñ
const onConditionTypeChange = () => {
  conditionForm.value.operator = availableOperators.value[0]?.value || 'eq'
  conditionForm.value.value = ''
  conditionForm.value.rangeFrom = ''
  conditionForm.value.rangeTo = ''
}

// Ëé∑ÂèñÊù°‰ª∂Á±ªÂûãÈ¢úËâ≤
const getConditionTypeColor = (type: string) => {
  const colors = {
    match: 'blue',
    term: 'green',
    range: 'orange',
    wildcard: 'purple',
    exists: 'cyan'
  }
  return colors[type as keyof typeof colors] || 'gray'
}

// Ëé∑ÂèñÊù°‰ª∂Á±ªÂûãÊ†áÁ≠æ
const getConditionTypeLabel = (type: string) => {
  const labels = {
    match: 'ÂåπÈÖç',
    term: 'Á≤æÁ°Æ',
    range: 'ËåÉÂõ¥',
    wildcard: 'ÈÄöÈÖç',
    exists: 'Â≠òÂú®'
  }
  return labels[type as keyof typeof labels] || type
}

// Ëé∑ÂèñÊìç‰ΩúÁ¨¶Ê†áÁ≠æ
const getOperatorLabel = (operator: string) => {
  const labels = {
    contains: 'ÂåÖÂê´',
    not_contains: '‰∏çÂåÖÂê´',
    eq: 'Á≠â‰∫é',
    neq: '‰∏çÁ≠â‰∫é',
    range: 'ËåÉÂõ¥'
  }
  return labels[operator as keyof typeof labels] || operator
}

// ‰ªéÁÆÄÂçïÊü•ËØ¢Êù°‰ª∂ÊûÑÂª∫ElasticsearchÊü•ËØ¢
const buildQueryFromConditions = () => {
  if (simpleQuery.value.conditions.length === 0) {
    return { match_all: {} }
  }
  
  const must: any[] = []
  const filter: any[] = []
  
  simpleQuery.value.conditions.forEach(condition => {
    switch (condition.type) {
      case 'match':
        if (condition.field === '_all') {
          must.push({ multi_match: { query: condition.value, fields: ['*'] } })
        } else {
          must.push({ match: { [condition.field]: condition.value } })
        }
        break
      case 'term':
        const termQuery = { term: { [condition.field + '.keyword']: condition.value } }
        if (condition.operator === 'neq') {
          filter.push({ bool: { must_not: termQuery } })
        } else {
          filter.push(termQuery)
        }
        break
      case 'range':
        const [from, to] = condition.value.split(' - ')
        filter.push({ range: { [condition.field]: { gte: from, lte: to } } })
        break
      case 'wildcard':
        must.push({ wildcard: { [condition.field + '.keyword']: `*${condition.value}*` } })
        break
      case 'exists':
        filter.push({ exists: { field: condition.field } })
        break
    }
  })
  
  if (must.length === 0 && filter.length === 0) {
    return { match_all: {} }
  }
  
  const query: any = { bool: {} }
  if (must.length > 0) query.bool.must = must
  if (filter.length > 0) query.bool.filter = filter
  
  return query
}

const loadIndices = async () => {
  if (!connectionStore.currentConnection) return
  await indexStore.fetchIndices(connectionStore.currentConnection.id)
}

const executeSearch = async () => {
  if (!connectionStore.currentConnection) {
    Message.error('ËØ∑ÂÖàÈÄâÊã©ËøûÊé•')
    return
  }

  if (!queryForm.value.index) {
    Message.error('ËØ∑ÈÄâÊã©Á¥¢Âºï')
    return
  }

  let finalQuery: any
  let sort: any = undefined

  try {
    // Ê†πÊçÆÊü•ËØ¢Ê®°ÂºèÊûÑÂª∫Êü•ËØ¢
    if (queryMode.value === 'simple') {
      finalQuery = buildQueryFromConditions()
      
      // ÊûÑÂª∫ÊéíÂ∫è
      if (simpleQuery.value.sort.length > 0) {
        sort = simpleQuery.value.sort
          .filter(s => s.field && s.order)
          .map(s => ({ [s.field]: { order: s.order } }))
      }
    } else {
      // È´òÁ∫ßÊ®°ÂºèÔºöÈ™åËØÅJSONÊ†ºÂºè
      if (!queryValid.value) {
        Message.error('Êü•ËØ¢Êù°‰ª∂JSONÊ†ºÂºèÈîôËØØÔºö' + queryValidationError.value)
        return
      }

      if (sortText.value.trim() && !sortValid.value) {
        Message.error('ÊéíÂ∫èÊù°‰ª∂JSONÊ†ºÂºèÈîôËØØÔºö' + sortValidationError.value)
        return
      }

      try {
        finalQuery = JSON.parse(queryText.value)
      } catch (error) {
        Message.error('Êü•ËØ¢Êù°‰ª∂JSONÊ†ºÂºèÈîôËØØ')
        return
      }

      if (sortText.value.trim()) {
        try {
          sort = JSON.parse(sortText.value)
        } catch (error) {
          Message.error('ÊéíÂ∫èÊù°‰ª∂JSONÊ†ºÂºèÈîôËØØ')
          return
        }
      }
    }

    const searchQuery = {
      index: queryForm.value.index,
      query: finalQuery,
      from: queryForm.value.from,
      size: queryForm.value.size,
      sort
    }

    await searchStore.executeSearch(connectionStore.currentConnection.id, searchQuery)
    
    // Â¶ÇÊûúÊúâËÅöÂêàÊï∞ÊçÆÔºåÊõ¥Êñ∞ÂèØËßÜÂåñÁªÑ‰ª∂
    if (searchStore.searchResult?.aggregations) {
      visualizationKey.value++
    }
  } catch (error) {
    console.error('Search failed:', error)
  }
}

const clearResults = () => {
  searchStore.resetSearchResult()
}

const setTemplate = (templateName: keyof typeof templates) => {
  queryText.value = templates[templateName]
}

// Validation handlers
const onQueryValidationChange = (isValid: boolean, error?: string) => {
  queryValid.value = isValid
  queryValidationError.value = error || ''
}

const onSortValidationChange = (isValid: boolean, error?: string) => {
  sortValid.value = isValid
  sortValidationError.value = error || ''
}

const onPageChange = async (page: number) => {
  console.log('Page change:', page, 'Size:', queryForm.value.size)
  
  if (!connectionStore.currentConnection) return
  
  // Êõ¥Êñ∞Êü•ËØ¢Ë°®ÂçïÁöÑ from ÂÄº
  queryForm.value.from = (page - 1) * (queryForm.value.size || 10)
  
  // ‰ΩøÁî® store ÁöÑ‰ºòÂåñÂàÜÈ°µÊñπÊ≥ï
  await searchStore.goToPage(connectionStore.currentConnection.id, page, queryForm.value.size)
  
  // È¢ÑÂä†ËΩΩ‰∏ã‰∏ÄÈ°µ
  nextTick(() => {
    if (connectionStore.currentConnection) {
      searchStore.preloadNextPage(connectionStore.currentConnection.id)
    }
  })
}

const onPageSizeChange = (pageSize: number) => {
  console.log('Page size change:', pageSize)
  
  if (pageSize < 1) pageSize = 10
  if (pageSize > 10000) pageSize = 10000
  
  // ËÆ°ÁÆóÂΩìÂâçÈ°µÁ†ÅÔºå‰øùÊåÅÂú®Âêå‰∏ÄÈ°µ
  const currentPage = Math.floor((queryForm.value.from || 0) / (queryForm.value.size || 10)) + 1
  
  // Êõ¥Êñ∞È°µÈù¢Â§ßÂ∞è
  queryForm.value.size = pageSize
  
  // ÈáçÊñ∞ËÆ°ÁÆó from ÂÄº‰ª•‰øùÊåÅÂú®Áõ∏‰ºº‰ΩçÁΩÆ
  queryForm.value.from = (currentPage - 1) * pageSize
  
  // Á°Æ‰øù from ‰∏çË∂ÖËøáÊÄªËÆ∞ÂΩïÊï∞
  if (searchResult.value && queryForm.value.from >= searchResult.value.total) {
    queryForm.value.from = Math.max(0, Math.floor((searchResult.value.total - 1) / pageSize) * pageSize)
  }
  
  executeSearch()
}

// Âä†ËΩΩÊõ¥Â§öÊï∞ÊçÆÔºàËôöÊãüÊªöÂä®Ê®°ÂºèÔºâ
const loadMoreData = async () => {
  if (!connectionStore.currentConnection || isLoadingMore.value || !hasMoreData.value) return
  
  try {
    isLoadingMore.value = true
    const nextFrom = allData.value.length
    const batchSize = 50 // ÊØèÊ¨°Âä†ËΩΩ50Êù°
    
    const searchQuery = {
      index: queryForm.value.index,
      query: JSON.parse(queryText.value),
      from: nextFrom,
      size: batchSize,
      sort: sortText.value.trim() ? JSON.parse(sortText.value) : undefined
    }
    
    // ‰ΩøÁî®ÊµÅÂºèÊêúÁ¥¢API
    const result = await Api.searchDocumentsStream(
      connectionStore.currentConnection.id, 
      searchQuery,
      batchSize,
      batchSize
    )
    
    if (result && result.length > 0) {
      allData.value.push(...result)
    }
  } catch (error) {
    console.error('Load more failed:', error)
    Message.error('Âä†ËΩΩÊõ¥Â§öÊï∞ÊçÆÂ§±Ë¥•')
  } finally {
    isLoadingMore.value = false
  }
}

// Â≠óÊÆµÈÄâÊã©Âô®ÊñπÊ≥ï
const selectAllFields = () => {
  if (searchResult.value && searchResult.value.hits) {
    selectedFields.value = extractFieldsFromResults(searchResult.value.hits)
  }
}

const clearFieldSelection = () => {
  selectedFields.value = []
}

// ÁõëÂê¨ÊêúÁ¥¢ÁªìÊûúÂèòÂåñÔºåËá™Âä®ÈÄâÊã©ÂâçÂá†‰∏™Â≠óÊÆµ
watch(searchResult, (newResult) => {
  if (newResult && newResult.hits && newResult.hits.length > 0) {
    const allFields = extractFieldsFromResults(newResult.hits)
    // Â¶ÇÊûúÁî®Êà∑ËøòÊ≤°ÊúâÈÄâÊã©Â≠óÊÆµÔºåÈªòËÆ§ÈÄâÊã©Ââç5‰∏™Â≠óÊÆµ
    if (selectedFields.value.length === 0 && allFields.length > 0) {
      selectedFields.value = allFields.slice(0, 5)
    }
  }
}, { immediate: true })

// ÁõëÂê¨ÊêúÁ¥¢storeÁöÑÊü•ËØ¢Áä∂ÊÄÅÂèòÂåñÔºåÂêåÊ≠•Âà∞Ë°®Âçï
watch(() => searchStore.query, (newQuery) => {
  if (newQuery && newQuery.index) {
    queryForm.value.index = newQuery.index
    queryForm.value.from = newQuery.from || 0
    queryForm.value.size = newQuery.size || 10
  }
}, { deep: true })

// Ë°åÁÇπÂáª‰∫ã‰ª∂
const onRowClick = (item: any, index: number) => {
  console.log('Row clicked:', item, index)
  // ÂèØ‰ª•Âú®ËøôÈáåÂÆûÁé∞ËØ¶ÊÉÖÊü•ÁúãÁ≠âÂäüËÉΩ
}

// ÁõëÂê¨ËßÜÂõæÊ®°ÂºèÂèòÂåñ
watch(viewMode, (newMode) => {
  if (newMode === 'virtual' && searchResult.value) {
    // ÂàáÊç¢Âà∞ËôöÊãüÊªöÂä®Êó∂ÔºåÂàùÂßãÂåñÊâÄÊúâÊï∞ÊçÆ
    allData.value = [...searchResult.value.hits]
  }
})
</script>

<style scoped>
.search-page {
  height: 100%;
  padding: 1rem;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid var(--color-border);
}

.header-left h1 {
  margin: 0 0 0.5rem 0;
  font-size: 2rem;
  font-weight: 700;
  background: linear-gradient(135deg, #1890ff, #722ed1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.subtitle {
  margin: 0;
  color: var(--color-text-3);
  font-size: 0.875rem;
}

.no-connection {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 400px;
  background: var(--color-fill-1);
  border-radius: 12px;
  border: 2px dashed var(--color-border);
}

.search-content {
  height: calc(100% - 120px);
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

/* Êü•ËØ¢Ë°åÊ†∑Âºè */
.query-row {
  flex-shrink: 0;
}

/* ÁªìÊûúË°åÊ†∑Âºè */
.results-row {
  flex: 1;
  min-height: 0;
}

/* Êü•ËØ¢ÈÖçÁΩÆÂíåÁÆÄÂçïÊü•ËØ¢Âç°ÁâáÊ†∑Âºè */
.config-card,
.simple-query-card,
.advanced-query-card {
  border-radius: 12px !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06) !important;
  border: 1px solid var(--color-border) !important;
  height: fit-content;
}

.simple-query-card,
.advanced-query-card {
  margin-top: 0 !important;
}

/* Êü•ËØ¢ÁªìÊûúÂå∫ÂüüÊ†∑Âºè */
.results-card {
  border-radius: 12px !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06) !important;
  border: 1px solid var(--color-border) !important;
  height: 100%;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.results-card .arco-card-body {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.results-card .arco-tabs {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.results-card .arco-tabs-content {
  flex: 1;
  overflow: hidden;
}

.card-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  color: var(--color-text-1);
}

/* Á¥¢ÂºïÈÄâÈ°πÊ†∑Âºè */
.index-option {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.index-name {
  font-weight: 600;
  color: var(--color-text-1);
}

.index-info {
  font-size: 0.75rem;
  color: var(--color-text-3);
}

/* ÁÆÄÂçïÊü•ËØ¢Áõ∏ÂÖ≥Ê†∑Âºè */
.quick-search {
  margin-bottom: 1rem;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.section-header h4 {
  margin: 0;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-text-2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Êù°‰ª∂È°πÊ†∑Âºè */
.condition-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
  background: var(--color-fill-1);
  border-radius: 8px;
  border: 1px solid var(--color-border);
  transition: all 0.2s ease;
}

.condition-item:hover {
  background: var(--color-fill-2);
  border-color: var(--color-primary);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.condition-content {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex: 1;
}

.field-name {
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-primary);
}

.operator {
  color: var(--color-text-3);
  font-size: 0.875rem;
}

.condition-value {
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 0.875rem;
  background: var(--color-fill-2);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  max-width: 150px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.empty-conditions {
  padding: 2rem;
  text-align: center;
}

/* ÊéíÂ∫èÈ°πÊ†∑Âºè */
.sort-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  padding: 0.5rem;
  background: var(--color-fill-1);
  border-radius: 6px;
  border: 1px solid var(--color-border);
}

/* ÂºπÁ™óÊ†∑Âºè */
.range-inputs {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* ÁªìÊûúÁõ∏ÂÖ≥Ê†∑Âºè */
.result-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
}

.result-stats {
  color: var(--color-text-3);
  font-size: 0.875rem;
  font-weight: 500;
  padding: 0.25rem 0.75rem;
  background: var(--color-fill-2);
  border-radius: 12px;
  border: 1px solid var(--color-border);
}

.table-controls {
  margin-bottom: 1rem;
  padding: 0.75rem;
  background: var(--color-fill-1);
  border-radius: 8px;
  border: 1px solid var(--color-border);
}

.data-info {
  color: var(--color-text-3);
  font-size: 0.875rem;
  font-weight: 500;
}

/* Ëá™Âä®Ë°•ÂÖ®ÊèêÁ§∫Ê†∑Âºè */
.autocomplete-hint {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-top: 0.5rem;
  padding: 0.5rem 0.75rem;
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
  border: 1px solid #0ea5e9;
  border-radius: 8px;
  font-size: 0.875rem;
  color: #0369a1;
}

.hint-text kbd {
  background: #1e40af;
  color: white;
  padding: 0.125rem 0.375rem;
  border-radius: 4px;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 0.75rem;
  font-weight: 600;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

/* ÂàÜÈ°µÊ†∑Âºè */
.pagination-wrapper {
  margin-top: 1.5rem;
  display: flex;
  justify-content: center;
  padding: 1rem;
  background: var(--color-fill-1);
  border-radius: 8px;
  border: 1px solid var(--color-border);
  position: sticky;
  bottom: 0;
  z-index: 5;
}

/* Ë°®Ê†ºÂçïÂÖÉÊ†ºÊ†∑Âºè */
.metadata-value {
  font-size: 0.875rem;
  color: var(--color-text-2);
  font-weight: 500;
}

.field-cell {
  display: flex;
  align-items: center;
  min-height: 40px;
  padding: 0.25rem 0;
}

.field-value {
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 0.875rem;
  color: var(--color-text-1);
  line-height: 1.4;
  word-break: break-word;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  max-height: 2.8em;
}

.field-value:empty::before {
  content: '-';
  color: var(--color-text-4);
  font-style: italic;
}

/* ËôöÊãüÊªöÂä®Áõ∏ÂÖ≥Ê†∑Âºè */
.doc-id {
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 0.75rem;
  color: var(--color-text-2);
  background: var(--color-fill-2);
  padding: 0.125rem 0.375rem;
  border-radius: 4px;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.score-badge {
  background: linear-gradient(135deg, var(--color-primary), #722ed1);
  color: white;
  padding: 0.125rem 0.5rem;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  font-family: 'Monaco', 'Menlo', monospace;
}

.source-preview {
  max-width: 350px;
  max-height: 50px;
  overflow: hidden;
}

.source-preview pre {
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 0.75rem;
  line-height: 1.4;
  color: var(--color-text-2);
  margin: 0;
  white-space: pre-wrap;
  word-break: break-word;
}

.source-data {
  background: var(--color-fill-1);
  padding: 1rem;
  border-radius: 8px;
  font-size: 0.75rem;
  line-height: 1.6;
  max-height: 200px;
  overflow: auto;
  margin: 0;
  border: 1px solid var(--color-border);
  font-family: 'Monaco', 'Menlo', monospace;
}

.json-result {
  background: #1e1e1e;
  color: #e2e8f0;
  padding: 1.5rem;
  border-radius: 8px;
  max-height: 600px;
  overflow: auto;
  font-size: 0.875rem;
  line-height: 1.6;
  margin: 0;
  border: 1px solid #374151;
  font-family: 'Monaco', 'Menlo', monospace;
}

/* Ê∑±Ëâ≤Ê®°ÂºèÈÄÇÈÖç */
@media (prefers-color-scheme: dark) {
  .autocomplete-hint {
    background: linear-gradient(135deg, #1e3a8a, #1e40af);
    border-color: #3b82f6;
    color: #93c5fd;
  }
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .page-header {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start;
  }
  
  .header-left h1 {
    font-size: 1.5rem;
  }
  
  .search-content .arco-col {
    margin-bottom: 1rem;
  }
}
</style>